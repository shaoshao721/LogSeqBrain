tags:: jvm，虚拟机对象

- 对象如何创建，如何布局，如何访问的
- 这里讲的是hotSpot虚拟机中的java堆为例
- 对象的创建
	- 普通的java对象，不包括数组和class对象
	- 遇到一条字节码new指令的时候
		- 1. 检查指令的参数是否能在常量池中定位到一个类的符号引用，检查这个符号引用代表的类是否已经被加载，解析初始化过。
		  2. 如果没有，就去执行类加载过程
		  3. 如果类已经加载了，虚拟机为新生对象分配内存。对象需要多少内存在类加载的时候就能确定。
			- 分配方式
				- 当堆内存边缘规整，用过的在一边，没用过的在一边，就把指针往空闲的方向挪一段，分配给这个对象（指针碰撞法
				- 当堆内存不规整，维护了一个列表记录了哪些内存块是可用的，在分配的时候就从这个列表里找一块足够容纳分配的对象的空间划分给对象实例，同时更新列表的记录（空闲列表法）
				- 用哪种分配方式由是否规整决定，是否规整由垃圾收集器是否有空间压缩整理的能力决定。serial，parnew就推荐用指针碰撞，cms这种基于sweep算法的收集器，推荐用空闲列表法
			- 分配可能产生的并发问题，同时修改指针位置
				- 1. 分配内存空间的对象采用同步处理，CAS配上失败重试来保证更新操作的原子性
				  2. 内存分配的动作按照线程放在不同空间中，每个线程在java堆里预先分配一小块内存，叫本地线程分配缓冲区。优先在线程分配的本地缓冲区里分配，缓冲区用完了，需要分配新的缓冲区的时候再进行同步锁定。通过-XX:+/-UseTLAB参数设定
			- 4. 分配了空间，将分配的内存空间初始化为零值，保证对象实例字段可以不用初始值就能使用
			  5. java虚拟机对对象进行必要设置，对象是哪个类的实例，如何找到类的元数据信息，对象哈希码，对象的GC分代年龄这些信息，放到对象头里。
			  6. new指令之后会执行构造方法进行初始化，对象真正被构造出来
	- CMS中，为了能在多数情况下分配得更快，设计了一个叫作Linear Allocation Buffer的分配缓冲区，通过空闲列表拿到一大块分配缓冲区之后，在它里面仍然可以使用指 针碰撞方式来分配。
-