tags:: 消息队列

- 网关如何接收服务端的秒杀结果
	- 网关接收到APP秒杀请求之后，给消息队列发送消息，并且进入等待状态，等待后端服务进行相应。
	- 后端服务从消息队列里取出消息，进行处理，并将结果回调回去，唤醒网关的服务
	- 网关的服务接受到请求并请求成功，就是秒杀成功，或者等待时间到了，就是没请求到，超时了，没抢到
	- ![image.png](../assets/image_1677935450829_0.png)
- 详解rocketMQ和kafka的消息模型
	- ![image.png](../assets/image_1677935483807_0.png)
	- broker就是一个服务端
	- 三个生产者如何对应到2个broker和5个队列里呢？不用对应，随便发，生产者随便找个队列发就行。
	- 一个消费组完整的拥有一个topic的所有数据，单独的拥有每个队列的消费位点。消费者和队列的关系，**每个队列只能被一个消费者实例占用**，这可能是因为，如果是要保证顺序的话，两个消费者不能保证顺序性了。消费位置在服务端保存，消费位置和消费者没关系。
- 如何实现单个队列并行消费
	- 在不严格要求顺序的时候，单个队列可以有多个消费者
	- 每个消费者拿一个消息去。如果过一会儿，三个消费都成功相应回来了，就把消费位点置为最大的那个
	- 但是，6，7回来了，5还没有相应回来。可以将5的消息复制到一个特殊重试队列，然后将消费位置更新到8，继续消费。当消费者来拉消息的时候，优先把重试队列中的消息给消费者。
- 如何保证消息的严格顺序
	- 主题层面没法保证，只能保证队列层面的
	- 用账户ID作为key，用哈希算法算出来队列编号，指定队列发送消息，保证相同key的消费发到同一个队列，保证相同的key能有顺序。
-
-
-
- TODO 这就说明进数的时候有挤压，可能是有机器不行了，消费返回的慢