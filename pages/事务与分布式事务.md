tags:: 事务，分布式事务

- 事务及ACID特性
	- 事务：用户定义的一些数据库操作，要么全部执行要么都不执行
	- 事务为引用层服务，方便业务系统的开发，简化业务系统的开发，简化业务系统的编程模型出现的
- 特性：
	- 原子性：要么全部提交成功，要么全部失败回滚，不能执行其中一部分。
	- 一致性：数据库的一致性及业务上的一致性。只能从一种有效状态变成另外一种有效状态。
	- 隔离性：一个事务所做的修改，在最终提交之前，对其他的事务都不可见。只有可串行化符合
		- 四种隔离级别
			- 读未提交 脏读
			- 读已提交 不可重复读
			- 可重复读 幻读
			- 串行化
		- 持久性：事务被提交了之后，他的改变是永久的。
- 分布式事务
	- 分布式事务是指事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于不同的[分布式系统]
- XA两阶段提交
	- 作为资源管理器及事务协调器的标准接口
		- XA
			- open,close 资源管理器的开启和关闭
			- start，end 开始结束一个本地事务
			- prepare，commit，rollback 事务协调器的预提交，提交和回滚
			- recover 回滚一个已经预提交的事务
		- AX
			- reg，unreg 资源管理器的注册。动态注册了之后，可以对事务iD进行操作
	- 用来管理分布式事务，保证数据的强一致性，解决很多临时性系统故障（进程，网络节点，通信）
	- 两段式提交
		- 第一阶段
			- 事务协调器通知参加该事务的所有资源管理器开始准备事务
			- 资源管理器在接收到消息器后开始准备（写事务日志并执行事务，但是不提交。
			- 提交就绪消息给事务协调器，这时候事务的大部分事情已经做完了
		- 第二阶段
			- 事务协调器收到各个资源管理器回复的消息后，基于投票结果进行决策，来判断提交或者取消。
			- 如果有一个失败，会回滚。否则提交
			- 各个资源管理器收到二阶段提交或回滚命令之后，执行并将结果返回给事务协调器。
		- 缺点
			- 同步阻塞问题。当在处理事务的过程中，其他第三方节点访问公共资源的时候就会处在阻塞状态
			- 单点故障。如果事务协调器发生故障的时候，参与者就会一直处于故障中
			- 数据不一致。如果在第二阶段，发送commit的过程中，有些已经发出去了，这个时候事务协调器发生故障或者发生了局部网络异常，就会出现数据不一致的问题
			- 状态不确定。如果事务协调器发出commit消息后宕机了，收到commit消息的参与者也宕机了，即使能够重新选举出来新的事务协调器，事务的状态也是不确定的。
	- CAP理论
		- 定义
			- consistency一致性 在更新操作成功并返回客户端之后，所有节点在同一时间的数据完全一致
			- available 可用性 服务一直可用，并有着正常的响应时间
			- partition tolerance 分区容错性 分布式系统在遇到节点或网络分区故障的时候，仍然能对外提供满足一致性和可用性的服务。
		- 如何选取
			- CP一般如果对数据要求比较高的，比如银行，金融。但是性能比较低。通常有XA两阶段提交
			- AP 数据不需要强一致性，保证最终一致性就行。常用方案TCC, 基于消息的最终一致性，saga等
	- BASE理论
		- 定义
		- BA basically available 基本可用。出现不可预知故障的时候，允许损失部分可用性。秒杀或者雪崩的时候，降级处理。保证核心功能能用。
		- S soft state 软状态。如果要求多个节点的数据副本是一致的，就是硬状态。但是允许系统里的数据存在中间状态，允许存在数据延时，是软状态
		- E eventually consistency 最终一致性
		- 是对CAP中一致性可用性进行权衡的结果。
	- TCC柔性事务
		- 前文提到两阶段提交有个缺点，当事务执行过程中，会导致第三方节点访问公共资源的时候造成阻塞。TCC采用的方式是，先把资源进行预留，把占用资源的锁释放掉。如果后续确认事务可以提交，就把资源用掉，如果事务回滚，就释放预留资源。
		- try，confirm，cancel其实可以类比两阶段提交中的，prepare，commit，rollback操作。
		- 区别是，tcc中，各个阶段的操作是由开发者自己把握的
		- 好处
			- 可以自定义数据库操作的粒度
			- 降低所冲突，提高吞吐量
		- 不足
			- 对应用的侵入性强，改造成本高
			- 实现难度大，要根据各种情况故障失败原因制定不同的回滚策略
	- 基于消息的最终一致性
	-