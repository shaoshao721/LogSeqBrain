tags:: 消息队列，mq，幂等性

- MQTT协议里提供的传递消息时的服务质量标准
	- at most once 消息最多会被送达一次。允许丢消息，对消息不可靠的场景，比如每分钟上报一次机房温度数据，可以接受数据少量丢失
	- at least once 至少一次，不允许丢消息但是能允许重复消息出现
	- exactly once 恰好一次，不允许丢失也不允许重复
	- rocketMQ，RabbitMQ，kafka都采用的是at least once
- 用幂等性解决重复消息问题
	- 从业务逻辑设计上入手，将消费的业务逻辑设计成具备幂等性的操作
		- 利用数据库的唯一约束实现幂等。不光是可以使用关系型数据库，只要是支持类似“INSERT IF NOT EXIST”语义的存储类系统都可以用于实现幂等，比如，你可以用 Redis 的 SETNX 命令来 替代数据库中的唯一约束，来实现幂等消费。
		- 为更新数据设置前置条件，满足条件才更新数据，否则拒绝更新数据。这种可以使用乐观锁来实现，给数据增加一个版本号属性，每次更改数据之后，要求当前数据的版本号要和消息中的版本号要一致。
		- 记录并检查操作。发送消息的时候，给每个消息指定一个全局唯一ID，消费前，先检查ID有没有被消费过。
			- 全局唯一ID的生成
			- 检查消费状态，更新数据，设置消费状态。需要保证原子性，否则会bug