tags:: mysql，mysql 架构

- mysql 结构的逻辑视图
	- ![image.png](../assets/image_1668853054198_0.png)
	- 上层的客户端包含的服务不是mysql独有的，主要是连接处理，身份验证，确保安全性等
	- 第二层是包含大多数mysql的核心功能，包括查询解析，分析，优化以及所有的内置函数(日期，时间，数学和加密函数)。所有跨存储引擎的功能，如存储过程，触发器，视图
		- 连接管理与安全性
			- 默认每个客户端连接会在服务器进程中有一个线程，连接的查询只会在这个单独的线程中执行，这个线程驻留在一个内核或者CPU上
			- 服务器维护了一个缓存区，来存放已经就绪的线程，不用每个新链接来创建或者销毁线程
			- 客户端连接到服务器上，会进行身份验证。基于主机名，用户名，密码来验证。连接通过后，会从权限表里查到拥有的权限。在后续的请求里，都会继续延续这个权限，除非重新进行连接。
			- 连接命令
				- ```
				  mysql -h$ip -P$port -u$user -p
				  ```
			- 连接完成后，如果没有后续动作，就处于空闲状态。在show processlist命令里能看到它。
			- 太长时间没动静，就会自动断开。由wait_timeout控制，默认8小时。
			- 长链接，短连接
				- 长链接，如果有持续的请求，就会一直用一个链接。
				- 短连接就每次执行完几次查询就断开连接，下次查询就重新建立一个
				- 一般都推荐用长链接，因为建立连接的操作很复杂。
				- 但是因为mysql在执行过程中临时使用的内存是管理在连接对象里的，这些资源在连接断开的时候才释放，就导致用长链接，mysql占用的内存涨的特别快。如果内存太大，会被系统强行OOM，看上去是mysql异常重启了一样
					- 解决方式：
					- 定期断开长链接，设置一段时间或判断执行过占用内存的大查询后，断开连接，之后查询再重连
					- 执行大操作后，执行mysql_rest_connection来重新初始化连接资源。不需要重连和做权限验证，但是会将链接恢复到刚创建完的状态
		- 优化和执行
			- 查询缓存
				- 已经被废弃，8.0已经被完全移除，因为只要对一个表进行更新，所有的查询缓存都会被清空。
				- 一般都在memcached或redis中缓存数据
			- 分析器
				- 会做词法分析，需要识别关键词，判断这个语句是否满足语法
				- 解析查询来创建内部数据结构(解析树)
			- 优化器
				- 决定用哪个索引
				- 重写查询
				- 决定表的读取顺序等
				- 用户也可以用特殊关键字来向优化器传递提示
				- 也能让服务器解释优化了哪些方面，方便用户进行修改
				- 存储引擎会对查询优化有影响
			- 执行器
				- 判断是否有查询权限
				- 执行器会根据表的引擎定义，去调用引擎提供的接口
	- 第三层存储引擎层，mysql的存储和提取。服务器通过存储引擎API进行通信，这些API屏蔽了不同存储引擎之间的差异，对上面的查询层基本上是透明的，存储引擎层包含了几十个底层函数，来执行一些，开始一个事务或者根据主键提取记录等操作。存储引擎不会去解析SQL，不同存储引擎之间也不相互通信。
		- 存储引擎，支持innodb，myisam，memory等存储引擎。
		- innodb会解析外键定义，因为mysql服务端没有实现这个功能